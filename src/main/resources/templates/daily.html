<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>钉钉e应用-日报</title>
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    <script src="/js/jquery-3.3.1.js"></script>
</head>
<body>
    <div class="daily">
    </div>
    <!--选择日志接收人-->
    <div class="js_box">
        <p class="add">添加日志接收人<b id="add_name">选择</b></p>
        <div id="name_list">

        </div>

    </div>
    <div class="btn" onclick="save()">
        提交
    </div>
    <div class="pop">

        <div class="popbox">
            <p class="seach">选择日志接收人：</p>
            <div id="change2">
            </div>
            <input type="button" value="确定" id="upload">
            <input type="button" value="取消" id="hide" onclick="hide()">
        </div>
    </div>
    <script src="/js/jquery-3.3.1.js"></script>
    <script>
        var curWwwPath=window.document.location.href;
        var pathName=window.document.location.pathname;
        var pos=curWwwPath.indexOf(pathName);
        var localhostPaht=curWwwPath.substring(0,pos);
        checkALL();
        insert();
        $('#add_name').click(function () {
            show();
        })
        $("#upload").click(function () {
            hide();
            checkALL();
        });
        //插入项目列表v
        function insert() {
            $.ajax({
                url:localhostPaht+"/journal/list",
                type:"post",
                cache:false,
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                async:false,
                data:null,
                success:function(res){
                    var i1=0;
                    var j1 =0;
                    if(res.code == 200){
                       for(var i=i1;i<res.data.result.length;i++){
                            $html=$('<div class="daily_list"></div>');
                            $('.daily').append($html);
                            $title=$('<div class="daily_title">'+res.data.result[i].p_name+'</div>')
                            $html.append($title);
                            $txtBox=$('<div class="daily_box"></div>');
                            $html.append($txtBox);
                            for (var j=j1;j<res.data.result.length;j++){
                                if(j > i){
                                    if(res.data.result[j].p_id == res.data.result[i].p_id ){
                                        $list=$('<div id="'+res.data.result[j].w_id+'" class="daily_left">'+res.data.result[j].w_work_report+'<span>完成进度(%)：<input type="text" value="'+res.data.result[j].r_finish+'"/><br/>工时(h)：<input type="text" value="0"/></span><div class="txt"><textarea >完成情况描述：</textarea></div></div>')
                                    }else{
                                        i1=j;
                                        j1=j;
                                        break;
                                    }
                                }else{
                                    $list=$('<div id="'+res.data.result[j].w_id+'" class="daily_left">'+res.data.result[j].w_work_report+'<span>完成进度(%)：<input type="text" value="'+res.data.result[j].r_finish+'"/><br/>工时(h)：<input type="text" value="0"/></span><div class="txt"><textarea >完成情况描述：</textarea></div></div>')
                                }

                                $txtBox.append($list);
                            }

                        }
                        //循环接收人列表
                        for(var i=0;i<res.data.userList.length;i++){
                            $lable=$('<label><input type="checkbox" id="'+res.data.userList[i].user_id+'" name="name" value="'+res.data.userList[i].u_name+'">'+res.data.userList[i].u_name+'</label>');
                            $('#change2').append($lable);
                        }
                    }
                }
            });
        }
        //插入日志接收人选择项
        function checkALL() {
            $('#name_list').html('');
            //获取被选中显示到页面
            var boxes=document.getElementsByTagName('input');
            for(var i=0;i<boxes.length;i++){
                if(boxes[i].checked==true){
                   var htmlList =$('<span>'+boxes[i].value+'</span>');
                }
                $('#name_list').append(htmlList)
            }
        }
        function show() {
            $('.pop').show();
        }
        function hide() {
            $('.pop').hide();
        }
//提交数据
        function save() {
           var arr=$(".daily_left").length;
           var item = [];
           var i = 1;
            $(".daily_left").each(function(){
                var wcjd=$(this).children("span").children("input").eq(0).val();
                var wcgs=$(this).children("span").children("input").eq(1).val();
                var  weekId= $(this).attr("id");
                var text=$(this).children("div").children("textarea").val();
                var param = {
                    wcjd:wcjd,
                    wcgs:wcgs,
                    weekId:weekId,
                    text:text
                };
                i++;
                item.push(param);
            });
            $.ajax({
                url:localhostPaht+"/journal/save",
                type:"post",
                cache:false,
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                async:false,
                data:JSON.stringify({para: item}),
                success:function(res){
                    if(res.code == 200){
                        alert(res.msg);

                    }
                }
            });

        }



    </script>
</body>
</html>