<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>项目总体计划新增、编辑</title>
    <link rel="stylesheet" type="text/css" href="./css/pages/project_table.css">
    <script src="./js/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="./element_ui/index.css">
    <link rel="stylesheet" href="./element_ui/iconfont/iconfont.css">
    <script src="./element_ui/vue.js" type="text/javascript"></script>
    <script src="./element_ui/index.js" type="text/javascript"></script>
    <script src="./element_ui/vuex.js" type="text/javascript"></script>
    <script src="./element_ui/store.js" type="text/javascript"></script>
    <script src="./element_ui/vue-resource.js" type="text/javascript"></script>
    <script src="./element_ui/vue-router.js" type="text/javascript"></script>
    <script src="//g.alicdn.com/dingding/dingtalk-jsapi/2.6.41/dingtalk.open.js"></script>
    <title>项目总体计划</title>
    <style>
        .el-tabs__nav-wrap.is-scrollable{
            padding: 0;
        }
        .el-tabs__nav-next, .el-tabs__nav-prev{
            display: none;
        }
        .el-tabs__nav{
            width: 100%;
        }
        .el-tabs__nav>div{
            width: 33.33333%;
            text-align: center;
            font-size: 12px;
            padding: 0;
        }
        .el-tabs__nav>div:nth-child(2){
            padding-left: 0 !important;
        }
        .el-tabs__nav>div:nth-child(3){
            padding-right: 0 !important;
        }
        .el-tabs__item{
            padding: 0;
        }
        .el-tabs__header{
            margin: 0;
        }


        /*表格*/
        .cell .el-input__inner{
            padding:0;
            text-align:center;
        }

        .el-table .cell, .el-table th div, .el-table--border td:first-child .cell, .el-table--border th:first-child .cell{
            padding-left: 0.03rem;
        }
        .el-table .cell, .el-table th div{
            padding-right: 0.03rem;
        }
        /*表头固定*/
        .idbody_title{
            z-index: 100;
            width: 100%;
            position: fixed;
            top:0;
            left:0;
        }
        /*主题内容*/
        .project-table-content{
            position: absolute;
            top:0.41rem;
            bottom: 0.42rem;
            left:0;
            right:0;
            overflow: auto;
        }
        /*提交按钮*/
        .submits{
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            width:100%;
            padding: 0.06rem;
            text-align: center;
            line-height: 0.3rem;
            font-size: 0.12rem;
            background:#e9ebed;
        }

        /*点击按钮变颜色*/
        .clickBtn{
            color:#409EFF;
        }


        /*弹出框样式修改*/
        .el-dialog__header{
            padding:0.1rem 4%;
        }
        .el-dialog__title{
            font-size:14px;
        }
        .el-dialog__body{
            padding: 0;
            font-size:12px;
        }
        .el-dialog{
            width: 92%;
            margin:10px auto;
            -webkit-box-shadow:0 1px 3px rgba(0,0,0,0);
        }
        .el-form-item__label{
            font-size: 12px;
        }
        .el-form-item__label{
            text-align: left;
        }
        .el-form-item__content{
            line-height: 0.4rem;
            width: 54%;
        }
        .el-form-item{
            margin-bottom: 0.1rem;
        }
    </style>
</head>
<body>
<div id="idbody">
    <div class="ztjh" v-if="shows">
        <div class="select">
            <div class="option">
                <div class="left">
                    <strong>年度:</strong>
                    <select>
                        <option>2019</option>
                        <option>2018</option>
                    </select>
                </div>
                <div class="right">
                    <el-input placeholder="请输入内容" v-model="searchTiaoJian" class="input-with-select">
                        <el-button slot="append" icon="el-icon-search" @click="searchs"></el-button>
                    </el-input>
                </div>
            </div>
        </div>
        <div class="totle">
            <div class="totle_list" v-for="(items,index) in listMessage" @click="listClick(items)">
                <p>{{items.pName}}</p>
                <span>计划开始时间：{{items.pStartTime}}</span>
                <span>项目阶段：{{items.pProjectPhaseId}}</span>
                <span>计划结束时间：{{items.pEndTime}}</span>
                <span>总体完成进度：{{items.pProgress}}%</span>
            </div>

        </div>
        <el-dialog
                title="新增项目列表"
                :visible.sync="dialogVisible"
                width="100%">
                <div class="el-dialog">
                    <el-form ref="form" :rules="rules" :model="forms" label-width="80">
                        <el-row>
                            <el-col :span="12">
                                <el-form-item  label="项目名称" prop="pName" label-width="1rem">
                                    <el-input v-model="forms.pName" placeholder="请输入项目名称"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="12">
                                <el-form-item  label="计划开始时间" prop="pStartTime" label-width="1rem">
                                    <el-input v-model="forms.pStartTime" placeholder="2018-09-18"></el-input>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item  label="计划结束时间" prop="pEndTime" label-width="1rem">
                                    <el-input v-model="forms.pEndTime" placeholder="2018-09-18"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                        <el-row>
                            <el-col :span="12">
                                <el-form-item  label="项目阶段" prop="pProjectPhaseId" label-width="1rem">
                                    <el-select v-model="forms.pProjectPhaseId" placeholder="请选择项目阶段">
                                        <el-option
                                                v-for="(item,index) in productJieDuan"
                                                :key="item.id"
                                                :label="item.name"
                                                :value="item.id">
                                        </el-option>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                            <el-col :span="12">
                                <el-form-item  label="项目完成进度" prop="pProgress" label-width="1rem">
                                    <el-input v-model="forms.pProgress" placeholder="请输入项目完成进度"></el-input>
                                </el-form-item>
                            </el-col>
                        </el-row>
                    </el-form>
                </div>
              <span slot="footer" class="dialog-footer">
                  <el-button size="small" @click="dialogVisible = false">取 消</el-button>
                  <el-button size="small" type="primary" @click="trueEvent('form')">确 定</el-button>
              </span>
        </el-dialog>
        <div class="submits" v-if="shows" :style="{color:isClickBtnColor1}" @click="addList" v-text="buttonsName"></div>
    </div>

    <div id="project_table" v-else-if="!shows">
        <div class="idbody_title">
            项目总体计划
        </div>
        <div class="project-table-content">
            <el-tabs v-model="activeName2" type="card" @tab-click="handleClick">
                <el-tab-pane label="明细计划-需求分析" name="1"></el-tab-pane>
                <el-tab-pane label="明细计划-数据处理" name="2"></el-tab-pane>
                <el-tab-pane label="明细计划-系统开发" name="3"></el-tab-pane>
            </el-tabs>

            <el-table class="tables"
                      border
                      :data="tableData"
                      style="width: 100%">
                <el-table-column
                        align="center"
                        label="任务类"
                >
                    <template slot-scope="scope">
                        {{scope.row.tName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="任务子类"
                        prop="index"
                >
                    <template slot-scope="scope">
                        {{scope.row.tsName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="任务项"
                        prop="index"
                >
                    <template slot-scope="scope">
                        {{scope.row.aName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="计划开始时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.apsTime" placeholder="请输入计划开始时间"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="计划完成时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.apeTime" placeholder="请输入计划完成时间"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="实际开始时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.aasTime" placeholder="请输入实际开始时间"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="实际完成时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.aaeTime" placeholder="请输入实际完成时间"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="负责人"
                        prop="index"

                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.userId" placeholder="请选择负责人">
                            <el-option
                                    v-for="item in zrr"
                                    :key="item.userId"
                                    :label="item.uName"
                                    :value="item.userId">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="完成百分比"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.percentage" placeholder="请输入完成百分比"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="状态"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.state" placeholder="请选择状态">
                            <el-option
                                    v-for="(item,index) in stateList"
                                    :key="item.id"
                                    :label="item.name"
                                    :value="item.id">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="成果物是否提交"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.isResult" placeholder="请选择是否">
                            <el-option
                                    v-for="(item,index) in isResultList"
                                    :key="item.id"
                                    :label="item.name"
                                    :value="item.id">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>
            </el-table>
        </div>

        <div class="submits" v-if="!shows" :style="{color:isClickBtnColor}" @click="submit" v-text="buttonsName"></div>
    </div>
</div>


<script>
    //匹配年月日
    var validatePass2 = (rule, value, callback) => {
        if (value === '') {
            callback(new Error('请输入日期时间'));
        } else {
            var re =  /([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8])))/;
            if (!re.test(value)) {
                callback(new Error('请输入正确的年月日格式'));
            };

            callback();
        };
    };
    //项目完成进度校验
    var validatePass1 = (rule, value, callback) => {
        if (value === '') {
            callback(new Error('请输入完成进度'));
        } else {
            var re =  /^[1-9]\d*$/;
            if (!re.test(value)) {
                callback(new Error('请输入正整数'));
            }else if (value>100){
                callback(new Error('完成进度不能超过100'));
            } ;

            callback();
        };
    };
    var myHome = new Vue({
        el:"#idbody",
        data:{
            buttonsName:"新增项目计划",

            pProjectPhaseIds:0,
            //弹出层
            dialogVisible:false,
            //form提交字段
            forms:{
                pId:"",
                pName:"",//项目名称
                pStartTime:"",//项目计划开始时间
                pEndTime:"",//项目计划结束时间
                pProjectPhaseId:"",//项目阶段ID
                pProgress:"",//项目总体完成进度
                createTime:"",//项目创建时间
                creater:"",//项目创建人
            },
            //表达验证
            rules:{
                pName:[
                    { required: true, message: '请输入项目名称', trigger: 'change' }
                ],
                pStartTime:[
                    { validator: validatePass2, trigger: 'blur' },
                ],
                pEndTime:[
                    { validator: validatePass2, trigger: 'blur' },
                ],
                pProjectPhaseId:[
                    { required: true, message: '请选择项目阶段', trigger: 'change' }
                ],
                pProgress:[
                    { validator: validatePass1, trigger: 'blur' },
                ],
            },
            //项目阶段
            productJieDuan:[
                {
                    name:"需求分析",
                    id:1,
                },
                {
                    name:"数据处理",
                    id:2,
                },
                {
                    name:"系统开发",
                    id:3,
                }
            ],

            //查询条件
            searchTiaoJian:"",
            pid:"",

            zrr:[],//责任人

            shows:true,
            listMessage:[],

            /*默认展示的tab切换页*/
            activeName2:"",
            tableData:[],

            /*状态*/
            stateList:[
                {
                    name:"未开始",
                    id:1,
                },
                {
                    name:"进行中",
                    id:2,
                },
                {
                    name:"已完成",
                    id:3,
                }
            ],
            /*成果是否提交*/
            isResultList:[
                {
                    name:"待提交",
                    id:1,
                },
                {
                    name:"已提交",
                    id:2,
                },
            ],
            /*按钮动态绑定的class*/
            isClickBtnColor1:"#000000",
            isClickBtnColor:"#000000",



            //确定是  修改还是提交  1为修改  2为提交
            showEditOrSubmit:1,
        },
        mounted:function(){
            var _this=this;
            _this.getDingDing();
        },
        methods:{
            //弹出框确定事件
            trueEvent:function(formName){
                var _this=this;
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        $.ajax({
                            url:"http://106.13.19.215:8082/MaintenanceProject/addProject",
                            async:true, // 请求是否异步,默认为异步,这也是ajax重要特性
                            data:JSON.stringify({
                                pId:_this.forms.pId,
                                pName:_this.forms.pName,
                                pStartTime:_this.forms.pStartTime,
                                pEndTime:_this.forms.pEndTime,
                                pProjectPhaseId:_this.forms.pProjectPhaseId,
                                pProgress:_this.forms.pProgress
                            }),
                            type:"POST",
                            dataType:"JSON",
                            contentType:"application/json;charset=utf-8",
                            success:function(res){
                                console.log(res);

                                if (res.code==200){
                                    _this.dialogVisible=false;
                                    var params={
                                        pName:"",
                                     };
                                    _this.getSearchData(params,false);
                                } else{
                                    _this.dialogVisible=true;
                                };

                            }
                        });
                    }else{
                        return false;
                    };
                })
            },

            //获取有关钉钉需要的值
            getDingDing:function () {
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/MaintenanceProject/queryEmterpriseMesg",
                    type:"GET",
                    data:{},
                    dataType:"json",
                    success:function(res){
                        _this.getCode(res);
                    }
                });
            },
            //获取临时授权码,
            getCode:function (_config) {
                console.log(_config);
                var _this=this;
                dd.ready(function() {
                    dd.runtime.permission.requestAuthCode({
                        corpId:_config.corpId, // 企业id
                        onSuccess: function (info) {
                            _this.code=info.code;
                            _this.getListMessage(info.code);//回显保存的数据
                        },
                        onFail : function(err) {
                            alert('fail: ' + JSON.stringify(err));
                        }
                    });
                });

            },

            //查询
            //获取查询的数据
            getSearchData:function(objs,bool){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/projectPlan/projectBypName",
                    async:true, // 请求是否异步,默认为异步,这也是ajax重要特性
                    data:JSON.stringify(objs),
                    type:"POST",
                    dataType:"JSON",
                    contentType:"application/json;charset=utf-8",
                    success:function(res){
                        if (res.code==200){
                            if (bool==true){
                                _this.$message.success(res.msg);
                            };


                            _this.listMessage=_this.sjzh(res.data);
                            _this.searchTiaoJian="";
                        };
                    }
                });
            },
            searchs:function(objs){
                var _this=this;
                var objs={
                    pName:_this.searchTiaoJian
                };
                _this.getSearchData(objs,true);
            },
            //校验显示状态
            getStates:function(nums){
                var _this=this;
                var str="";
                if (nums ==1){
                    str = "未开始";
                } else if (nums ==2){
                    str = "进行中";
                }else if (nums ==3){
                    str = "已完成";
                };
                return str;
            },

            //项目阶段数据转换
            sjzh:function(data){
                var _this=this;
                for(var i=0;i<data.length;i++){
                    var items=data[i];
                    if (items.pProjectPhaseId==1) {
                        items.pProjectPhaseId="需求分析"
                    }else if (items.pProjectPhaseId==2) {
                        items.pProjectPhaseId="数据处理"
                    }else if (items.pProjectPhaseId==3) {
                        items.pProjectPhaseId="系统开发"
                    };
                };
                return data;
            },

            //获取列表信息
            getListMessage:function(code){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/projectPlan/listAll",
                    data:{'authCode':code},
                    type:"POST",
                    dataType:"json",
                    success:function(res){
                        _this.listMessage=_this.sjzh(res.data);
                        _this.getFzr();
                    }
                });
            },

            //获取所有负责人
            getFzr:function(){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/user/selectAllUser",
                    data:{
                    },
                    type:"GET",
                    dataType:"json",
                    success:function(res){
                        _this.zrr=_this.sjzh(res.data);
                    }
                });
            },

            //点击列表信息
            listClick:function (items) {
                var _this=this;
                _this.buttonsName="提交";
                _this.shows=false;
                _this.isClickBtnColor="#000000";

                if(items.pProjectPhaseId=="需求分析"){
                    items.pProjectPhaseId="1";
                }else if(items.pProjectPhaseId=="数据处理"){
                    items.pProjectPhaseId="2";
                }else if(items.pProjectPhaseId=="系统开发"){
                    items.pProjectPhaseId="3";
                };

                _this.pProjectPhaseIds=items.pProjectPhaseId;
                _this.activeName2=items.pProjectPhaseId;

                _this.pid=items.pId;
                _this.getProject(items);
            },

            /*获取项目总体甲基化清单明细*/
            getProject:function(params){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/projectPlan/projectPlanList",
                    data:{
                        pId:params.pId,
                        pProjectPhaseId:params.pProjectPhaseId,
                    },
                    type:"POST",
                    dataType:"json",
                    success:function(res){
                         _this.showEditOrSubmit=1;
                        for (var i=0;i<res.data.length;i++){
                            var items=res.data[i];
                            if (items.aaeTime!=null||items.aasTime!=null||items.apeTime!=null||items.apsTime!=null||items.isResult!=null||items.percentage!=null||items.state!=null||items.username!=null||items.userId!=null) {
                                _this.showEditOrSubmit=2;
                                //break;
                            }
                          /*  else{
                                _this.showEditOrSubmit=1;
                                break;
                            };*/
                        } 

                        _this.tableData=res.data;


                    }
                });
            },
            /*点击项目总体计划明细tab*/
            handleClick:function(data){
                var _this=this;
                var params={
                    pId:_this.pid,
                    pProjectPhaseId:data.name,
                };
                _this.getProject(params);
            },
            /*新增项目列表事件*/
            addList:function(){
                var _this=this;
                _this.isClickBtnColor1="#409EFF";

                _this.dialogVisible=true;
            },
            /*提交事件*/
            submit:function(){
                var _this=this;
                _this.isClickBtnColor="#409EFF";
                var newArray=[];
                for (var i=0;i<_this.tableData.length;i++){
                    var items=_this.tableData[i];
                    var objss={
                        aId: items.aId,
                        aName:items.aName,
                        tsId:items.tsId,
                        aPstartTime: items.apsTime,
                        aPendTime: items.apeTime,
                        aAstartTime: items.aasTime,
                        aAendTime: items.aaeTime,
                        userId: items.userId,
                        aPercentage: items.percentage,
                        aState: items.state,
                        aIsResult: items.isResult,
                        pId: _this.pid,
                        pProjectPhaseId: _this.pProjectPhaseIds,
                    };
                    newArray.push(objss);
                };
                var objs={
                    items:newArray
                };
                var urls="";
                if (_this.showEditOrSubmit==1){
                    urls="http://106.13.19.215:8082/MaintenanceProject/addProjectList";
                } else{
                    urls="http://106.13.19.215:8082/actionItem/updateActionItemList";
                };

                $.ajax({
                    url:urls,
                    data:JSON.stringify(objs),
                    type:"post",
                    dataType:"JSON",
                    contentType: "application/json;charset=utf-8",
                    success:function(res){
                        if (res.code==200){
                            _this.$message.success(res.msg);

                            setTimeout(function () {
                                _this.shows=true;
                                _this.buttonsName="新增项目计划";
                            },2000);
                        };
                    }
                });
            },
        },
        updated:function(){
            var _this=this;

        },
    });
</script>
</body>
</html>