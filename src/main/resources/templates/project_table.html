<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>项目总体计划新增、编辑</title>
    <link rel="stylesheet" type="text/css" href="./css/pages/project_table.css">
    <script src="./js/jquery-3.3.1.js"></script>
    <link rel="stylesheet" href="./element_ui/iconfont/iconfont.css">
    <script src="./element_ui/vue.js" type="text/javascript"></script>
    <script src="./element_ui/vuex.js" type="text/javascript"></script>
    <script src="./element_ui/store.js" type="text/javascript"></script>
    <script src="./element_ui/vue-resource.js" type="text/javascript"></script>
    <script src="./element_ui/vue-router.js" type="text/javascript"></script>
    <script src="//g.alicdn.com/dingding/dingtalk-jsapi/2.6.41/dingtalk.open.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <title>项目信息</title>
    <style>
        .el-tabs__nav-wrap.is-scrollable {
            padding: 0;
        }

        .el-tabs__nav-next, .el-tabs__nav-prev {
            display: none;
        }

        .el-tabs__nav {
            width: 100%;
        }

        .el-tabs__nav > div {
            width: 33.33333%;
            text-align: center;
            font-size: 12px;
            padding: 0;
        }

        .el-tabs__nav > div:nth-child(2) {
            padding-left: 0 !important;
        }

        .el-tabs__nav > div:nth-child(3) {
            padding-right: 0 !important;
        }

        .el-tabs__item {
            padding: 0;
        }

        .el-tabs__header {
            margin: 0;
        }


        /*表格*/
        .cell .el-input__inner {
            padding: 0;
            text-align: center;
        }

        .el-table .cell, .el-table th div, .el-table--border td:first-child .cell, .el-table--border th:first-child .cell {
            padding-left: 0.03rem;
        }

        .el-table .cell, .el-table th div {
            padding-right: 0.03rem;
        }

        /*表头固定*/
        .idbody_title {
            z-index: 100;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }

        /*主题内容*/
        .project-table-content,.totle {
            position: absolute;
            top: 0.41rem;
            bottom: 0.5rem;
            left: 0;
            right: 0;
            -webkit-overflow-scrolling: touch;
            overflow-y: scroll;
        }

        /*提交按钮*/
        .submits {
            cursor:pointer;
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0.06rem;
            text-align: center;
            line-height: 0.3rem;
            font-size: 0.12rem;
            background: #409eff;
            color: white;
        }

        /*点击按钮变颜色*/
        .clickBtn {
            color: #409EFF;
        }


        /*弹出框样式修改*/
        .el-dialog__header {
            padding: 0.1rem 4%;
        }

        .el-dialog__title {
            font-size: 14px;
        }

        .el-dialog__body {
            padding: 0;
            font-size: 12px;
        }

        .el-dialog {
            width: 92%;
            margin: 10px auto;
            -webkit-box-shadow: 0 1px 3px rgba(0, 0, 0, 0);
        }

        .el-form-item__label {
            font-size: 12px;
        }

        .el-form-item__label {
            text-align: left;
        }

        .el-form-item__content {
            line-height: 0.4rem;
            width: 54%;
        }

        .el-form-item {
            margin-bottom: 0.1rem;
        }

        .el-input__icon {
            line-height: 30px !important;
        }
        .left .el-select{
            width:0.8rem;
        }
        .right{
            width: 1.5rem;
            margin-left:0.04rem;
        }

        .cell>.el-date-editor.el-input, .el-date-editor.el-input__inner{
            width:100%;
        }
    </style>
</head>
<body>
<div id="idbody">
    <div class="ztjh" v-if="shows">
        <div class="select">
            <div class="option">
                <div class="left">
                    <!--年份-->
                    <strong>年度:</strong>
                    <el-select v-model="params.annualTime" placeholder="请选择" @change="timeChange">
                        <el-option
                                key=""
                                label="请选择年份"
                                value="">
                        </el-option>
                        <el-option
                                key="2018"
                                label="2018"
                                value="2018">
                        </el-option>
                        <el-option
                                key="2019"
                                label="2019"
                                value="2019">
                        </el-option>
                    </el-select>
                    <!--阶段-->
                    <el-select v-model="params.pProjectPhaseId" placeholder="请选择" @change="timeChange">
                        <el-option
                                key=""
                                label="请选择阶段"
                                value="">
                        </el-option>
                        <el-option
                                v-for="(item,index) in productJieDuan"
                                :key="item.id"
                                :label="item.name"
                                :value="item.id">
                        </el-option>
                    </el-select>
                </div>
                <div class="right">
                    <el-input placeholder="请输入内容" v-model="params.pName" class="input-with-select">
                        <el-button slot="append" icon="el-icon-search" @click="searchs"></el-button>
                    </el-input>
                </div>
            </div>
        </div>
        <div style="text-align: center;line-height: 60px;width: 100%;" v-if="listMessage.length<=0?true:false">暂无数据
        </div>
        <div class="totle" v-else-if="listMessage.length>0?true:false">
            <div class="totle_list" v-for="(items,index) in listMessage" @click="listClick(items)">
                <p v-text="items.pName"></p>
                <span><strong>计划开始时间：</strong><strong v-text="items.pStartTime"></strong></span>
                <span><strong>项目阶段：</strong><strong v-text="items.pProjectPhaseName"></strong></span>
                <span><strong>计划结束时间：</strong><strong v-text="items.pEndTime"></strong></span>
                <span><strong>总体完成进度：</strong><strong><strong v-text="items.pProgress"></strong><strong>%</strong></strong></span>

                <div class="methods">
                    <i class="iconfont icon-bianji" style="font-size: 0.12rem;" @click="projectEdit(items,$event)"></i>
                    <i class="iconfont icon-shanchu" @click="projectDel(items,$event)"></i>
                </div>
            </div>

        </div>
        <el-dialog
                :title="diaLogTitle"
                :visible.sync="dialogVisible"
                width="100%">
            <div class="el-dialog">
                <el-form ref="form" :rules="rules" :model="forms" label-width="80">
                    <el-row>
                        <el-col :span="12">
                            <el-form-item label="项目名称" prop="pName" label-width="0.7rem">
                                <el-input v-model="forms.pName" placeholder="请输入项目名称"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12">
                            <el-form-item label="开始时间" prop="pStartTime" label-width="0.7rem">
                                <el-date-picker
                                        v-model="forms.pStartTime"
                                        type="date"
                                        placeholder="2019-07-09">
                                </el-date-picker>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="结束时间" prop="pEndTime" label-width="0.7rem">
                                <el-date-picker
                                        v-model="forms.pEndTime"
                                        type="date"
                                        placeholder="2019-07-09">
                                </el-date-picker>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12">
                            <el-form-item label="项目阶段" prop="pProjectPhaseId" label-width="0.7rem">
                                <el-select v-model="forms.pProjectPhaseId"
                                           placeholder="请选择项目阶段">
                                    <el-option
                                            v-for="(item,index) in productJieDuan"
                                            :key="item.id"
                                            :label="item.name"
                                            :value="item.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="完成进度" prop="pProgress" label-width="0.7rem">
                                <el-input v-model="forms.pProgress" placeholder="请输入项目完成进度"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </div>
            <span slot="footer" class="dialog-footer">
                  <el-button size="small" @click="dialogVisible = false">取 消</el-button>
                  <el-button size="small" type="primary" @click="trueEvent('form')">确 定</el-button>
              </span>
        </el-dialog>
        <div class="submits" v-if="shows" @click="addList" v-text="buttonsName"></div>
    </div>

    <div id="project_table" v-else-if="!shows">
        <div class="idbody_title">
            项目总体计划
        </div>
        <div class="project-table-content">
            <el-tabs v-model="activeName2" type="card" @tab-click="handleClick">
                <el-tab-pane label="明细计划-需求分析" name="1"></el-tab-pane>
                <el-tab-pane label="明细计划-数据处理" name="2"></el-tab-pane>
                <el-tab-pane label="明细计划-系统开发" name="3"></el-tab-pane>
            </el-tabs>

            <el-table class="tables"
                      border
                      :data="tableData"
                      style="width: 100%">
                <el-table-column
                        align="center"
                        label="任务类"
                >
                    <template slot-scope="scope">
                        {{scope.row.tName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="任务子类"
                        prop="index"
                >
                    <template slot-scope="scope">
                        {{scope.row.tsName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="任务项"
                        prop="index"
                >
                    <template slot-scope="scope">
                        {{scope.row.aName}}
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="计划开始时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-date-picker
                                v-model="scope.row.apsTime"
                                type="date"
                                placeholder="2019-07-09" :picker-options="apsPicker" @change="apsTimeChange(scope.row.apsTime)">
                        </el-date-picker>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="计划完成时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-date-picker
                                v-model="scope.row.apeTime"
                                type="date"
                                placeholder="2019-07-09" :picker-options="apePicker" @change="apeTimeChange(scope.row.apeTime)">
                        </el-date-picker>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="实际开始时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-date-picker
                                v-model="scope.row.aasTime"
                                type="date"
                                placeholder="2019-07-09">
                        </el-date-picker>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="实际完成时间"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-date-picker
                                v-model="scope.row.aaeTime"
                                type="date"
                                placeholder="2019-07-09">
                        </el-date-picker>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="负责人"
                        prop="index"

                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.userId" placeholder="请选择负责人">
                            <el-option
                                    v-for="item in zrr"
                                    :key="item.userId"
                                    :label="item.name"
                                    :value="item.userId">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="完成百分比"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-input v-model="scope.row.percentage" placeholder="50"></el-input>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="状态"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.state" placeholder="请选择状态">
                            <el-option
                                    v-for="(item,index) in stateList"
                                    :key="item.id"
                                    :label="item.name"
                                    :value="item.id">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>

                <el-table-column
                        align="center"
                        label="成果物是否提交"
                        prop="index"
                >
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.isResult" placeholder="请选择是否">
                            <el-option
                                    v-for="(item,index) in isResultList"
                                    :key="item.id"
                                    :label="item.name"
                                    :value="item.id">
                            </el-option>
                        </el-select>
                    </template>
                </el-table-column>
            </el-table>
        </div>

        <div class="submits" v-if="!shows" @click="submit" v-text="buttonsName"></div>
    </div>
</div>


<script>
    //匹配年月日
    var validatePass2 = (rule, value, callback) =>{
        console.log(value)
        if (value === '') {
            callback(new Error('请输入日期时间'));
        } else {
            var re = /([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8])))/;
            if (!re.test(value)) {
                callback(new Error('请输入正确的年月日格式'));
            };

            callback();
        };
    };
    //项目完成进度校验
    var validatePass1 = (rule, value, callback) =>{
        if (value === '') {
            callback(new Error('请输入完成进度'));
        } else {
            var re = /^[1-9]\d*$/;
            if (!re.test(value)) {
                callback(new Error('请输入正整数'));
            } else if (value > 100) {
                callback(new Error('完成进度不能超过100'));
            };

            callback();
        };
    };
    var myHome = new Vue({
        el: "#idbody",
        data: {
            //计划开始时间  禁用范围
            apsPicker:{},
            //计划完成时间   禁用范围
            apePicker:{},

            //编辑的时候项目阶段  禁用
            // pProjectPhaseIdDisabled:false,

            isEditOrAdd:0,
            //弹框  title
            diaLogTitle:"新增项目列表",

            buttonsName: "新增项目计划",

            pProjectPhaseIds: 0,
            //弹出层
            dialogVisible: false,
            //form提交字段
            forms: {
                pId: "",
                pName: "",//项目名称
                pStartTime: "",//项目计划开始时间
                pEndTime: "",//项目计划结束时间
                pProjectPhaseId: "",//项目阶段ID
                pProgress: "",//项目总体完成进度
                createTime: "",//项目创建时间
                creater: "",//项目创建人
            },
            //表达验证
            rules: {
                pName: [
                    {required: true, message: '请输入项目名称', trigger: 'change'}
                ],
                pStartTime: [
                    {required: true, message: '请选择开始时间', trigger: 'change'}
                ],
                pEndTime: [
                    {required: true, message: '请选择结束时间', trigger: 'change'}
                ],
                pProjectPhaseId: [
                    {required: true, message: '请选择项目阶段', trigger: 'change'}
                ],
                pProgress: [
                    {validator: validatePass1, trigger: 'blur'},
                ],
            },
            //项目阶段
            productJieDuan: [
                {
                    name: "需求分析",
                    id: 1,
                },
                {
                    name: "数据处理",
                    id: 2,
                },
                {
                    name: "系统开发",
                    id: 3,
                }
            ],

            //查询条件
            //查询条件
            params: {
                annualTime: "",//时间
                pName: "",//输入框
                pProjectPhaseId:"",
            },

            pid: "",

            zrr: [],//责任人

            shows: true,
            listMessage: [],

            /*默认展示的tab切换页*/
            activeName2: "",
            tableData: [],

            /*状态*/
            stateList: [
                {
                    name: "进行中",
                    id: 1,
                },
                {
                    name: "暂停",
                    id: 2,
                },
                {
                    name: "已完成",
                    id: 3,
                }
            ],
            /*成果是否提交*/
            isResultList: [
                {
                    name: "待提交",
                    id: 1,
                },
                {
                    name: "已提交",
                    id: 2,
                },
            ],
            /*按钮动态绑定的class*/
            isClickBtnColor1: "#000000",
            isClickBtnColor: "#000000",


            //确定是  修改还是提交  1为修改  2为提交
            showEditOrSubmit: 1,

            //防止极限点击
            jiXianClick:1,
            jiXianClick1:1,
        },
        mounted: function () {
            var _this = this;
            _this.getDingDing();
            //_this.getListMessage();
        },
        methods: {
            //计划开始时间
            apsTimeChange:function(times){
                var _this=this;
                _this.apsPicker={};
                _this.apePicker={
                    disabledDate:function(time) {
                        return time.getTime() < times.getTime();
                    }
                }
            },
            //计划结束时间
            apeTimeChange:function(times){
                var _this=this;
                _this.apePicker={};
                _this.apsPicker={
                    disabledDate:function(time) {
                        return time.getTime() > times.getTime();
                    }
                }
            },
            //项目删除
            projectDel:function(params,event){
                var _this=this;
                event.cancelBubble = true;//组织事件冒泡

                this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    var objs={
                        pId:params.pId,
                    };
                    $.ajax({
                        url: "http://106.13.24.63:8082/projectPlan/deleteProjectBypId",
                        async: true, // 请求是否异步,默认为异步,这也是ajax重要特性
                        data: objs,
                        type: "POST",
                        dataType: "JSON",
                        success: function (res) {
                            console.log(res);
                            if(res.code==200){
                                _this.$message({
                                    message:"删除成功",
                                    type:"success",
                                });
                                //_this.getListMessage();
                                _this.getDingDing();
                            }else{
                                _this.$message({
                                    message:"删除失败",
                                    type:"warning",
                                });
                            };
                        }
                    });
                }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                });
            },
            //项目编辑
            projectEdit:function(objs,event){
                var _this=this;
                event.cancelBubble = true;//组织事件冒泡
                _this.diaLogTitle="编辑项目计划";
                _this.isEditOrAdd=1;
                _this.dialogVisible=true;
                //
                // _this.pProjectPhaseIdDisabled=true;
                var startTime=objs.pStartTime;
                var endTime=objs.pEndTime;

                startTime=new Date(startTime.substr(0,4),Number(startTime.substr(5,2))-1,startTime.substr(8,2),0,0,0);
                endTime=new Date(endTime.substr(0,4),Number(endTime.substr(5,2))-1,endTime.substr(8,2),0,0,0);
                _this.forms={
                    pId: objs.pId,
                    pName: objs.pName,//项目名称
                    pStartTime: startTime,//项目计划开始时间
                    pEndTime:  endTime,//项目计划结束时间
                    pProjectPhaseId: objs.pProjectPhaseId,//项目阶段ID
                    pProgress: objs.pProgress,//项目总体完成进度
                };

                _this.$refs.form.clearValidate();//清空之前的校验

            },

            //弹出框确定事件
            trueEvent: function (formName) {
                var _this = this;
                console.log(_this.jiXianClick1)
                this.$refs[formName].validate((valid) => {
                    if(valid) {
                        if(_this.jiXianClick1==1){
                           /* console.log(_this.forms.pStartTime,_this.forms.pStartTime.getDate())*/
                            // if(_this.forms.pStartTime!=""){
                            //     _this.forms.pStartTime=new Date(_this.forms.pStartTime.getFullYear(),_this.forms.pStartTime.getMonth(),_this.forms.pStartTime.getDate()+1,24,60,60);
                            // };
                            // if(_this.forms.pEndTime!=""){
                            //     _this.forms.pEndTime=new Date(_this.forms.pEndTime.getFullYear(),_this.forms.pEndTime.getMonth(),_this.forms.pEndTime.getDate()+1,24,60,60);
                            // };
                            _this.jiXianClick1=2;

                            if(_this.isEditOrAdd==1){
                                //编辑事件
                                //添加事件
                                $.ajax({
                                    url: "http://106.13.24.63:8082/projectPlan/updateProjectBypId",
                                    async: true, // 请求是否异步,默认为异步,这也是ajax重要特性
                                    // data: JSON.stringify({
                                    //     pId: _this.forms.pId,
                                    //     pName: _this.forms.pName,
                                    //     pStartTime: new Date(_this.forms.pStartTime.getFullYear(),_this.forms.pStartTime.getMonth(),_this.forms.pStartTime.getDate()+1,0,0,0),
                                    //     pEndTime: new Date(_this.forms.pEndTime.getFullYear(),_this.forms.pEndTime.getMonth(),_this.forms.pEndTime.getDate()+1,0,0,0),
                                    //     pProjectPhaseId: _this.forms.pProjectPhaseId,
                                    //     pProgress: _this.forms.pProgress
                                    // }),
                                    data: {
                                        'pId': _this.forms.pId,
                                        'pName': _this.forms.pName,
                                        'pStartTime': _this.forms.pStartTime,
                                        'pEndTime': _this.forms.pEndTime,
                                        'pProjectPhaseId': _this.forms.pProjectPhaseId,
                                        'pProgress': _this.forms.pProgress
                                    },
                                    type: "POST",
                                    dataType: "JSON",
                                    //contentType: "application/json;charset=utf-8",
                                    success: function (res) {
                                        //console.log(res);
                                        if (res.code == 200) {
                                            _this.dialogVisible = false;
                                            _this.getSearchData(false);
                                        } else {
                                            _this.dialogVisible = true;
                                        };
                                        _this.jiXianClick1=1;

                                    },
                                    error:function(res){
                                        _this.jiXianClick1=1;
                                    }
                                });
                            }else{
                                //添加事件
                                $.ajax({
                                    url: "http://106.13.24.63:8082/MaintenanceProject/addProject",
                                    async: true, // 请求是否异步,默认为异步,这也是ajax重要特性
                                    data: {
                                        'pName': _this.forms.pName,
                                        'pStartTime': _this.forms.pStartTime,
                                        'pEndTime': _this.forms.pEndTime,
                                        'pProjectPhaseId': _this.forms.pProjectPhaseId,
                                        'pProgress': _this.forms.pProgress
                                    },
                                    type: "POST",
                                    dataType: "JSON",
                                    // contentType: "application/json;charset=utf-8",
                                    success: function (res) {
                                        //console.log(res);
                                        if (res.code == 200) {
                                            _this.dialogVisible = false;
                                            //_this.getListMessage();
                                            _this.getDingDing();
                                        } else {
                                            _this.dialogVisible = true;
                                        };
                                        _this.jiXianClick1=1;
                                        _this.forms={
                                            pId: "",
                                            pName: "",//项目名称
                                            pStartTime: "",//项目计划开始时间
                                            pEndTime: "",//项目计划结束时间
                                            pProjectPhaseId: "",//项目阶段ID
                                            pProgress: "",//项目总体完成进度
                                            createTime: "",//项目创建时间
                                            creater: "",//项目创建人
                                        };
                                    },
                                    error:function(res){
                                        _this.jiXianClick1=1;
                                    }
                                });
                            };
                        }else{
                            _this.$message({
                                message:"请勿多次新增项目",
                                type:"warning",
                            });

                        };


                    }else{
                        return false;
                    };
                 });


            },

           //获取有关钉钉需要的值
            getDingDing: function () {
                var _this = this;
                $.ajax({
                    url: "http://106.13.24.63:8082/MaintenanceProject/queryEmterpriseMesg",
                    type: "GET",
                    data: {},
                    dataType: "json",
                    success: function (res) {
                        _this.getCode(res);
                    }
                });
            },
            //获取临时授权码,
            getCode: function (_config) {
                console.log(_config);
                var _this = this;
                dd.ready(function () {
                    dd.runtime.permission.requestAuthCode({
                        corpId: _config.corpId, // 企业id
                        onSuccess: function (info) {
                            _this.code = info.code;
                           _this.getSearchData(info.code);//回显保存的数据
                        },
                        onFail: function (err) {
                            alert('fail: ' + JSON.stringify(err));
                        }
                    });
                });

            },

            //查询
            //获取查询的数据
            getSearchData: function (bool) {
                var _this = this;
                $.ajax({
                    url: "http://106.13.24.63:8082/projectPlan/projectBypName",
                    async: true, // 请求是否异步,默认为异步,这也是ajax重要特性
                    data: _this.params,
                    type: "POST",
                    dataType: "JSON",
                    success: function (res) {
                        if (res.code == 200) {
                            if (bool == true) {
                            };
                            _this.listMessage = res.data;
                            _this.searchTiaoJian = "";
                        }
                    }
                });
            },
            searchs: function (objs) {
                var _this = this;

                _this.getSearchData(true);
            },
            timeChange:function(){
                var _this=this;
                _this.getSearchData(true);
            },
            //校验显示状态
            getStates: function (nums) {
                var _this = this;
                var str = "";
                if (nums == 1) {
                    str = "未开始";
                } else if (nums == 2) {
                    str = "进行中";
                } else if (nums == 3) {
                    str = "已完成";
                }
                ;
                return str;
            },

            //项目阶段数据转换
            sjzh: function (data) {
                var _this = this;
                for (var i = 0; i < data.length; i++) {
                    var items = data[i];
                    if (items.pProjectPhaseId == 1) {
                        items.pProjectPhaseId = "需求分析"
                    } else if (items.pProjectPhaseId == 2) {
                        items.pProjectPhaseId = "数据处理"
                    } else if (items.pProjectPhaseId == 3) {
                        items.pProjectPhaseId = "系统开发"
                    };
                }
                ;
                return data;
            },

            //获取列表信息
            getListMessage: function (code) {
                var _this = this;
                $.ajax({
                    url: "http://106.13.24.63:8082/projectPlan/listAll",
                    data: {'authCode':code},
                    //data: {},
                    type: "POST",
                    dataType: "json",
                    success: function (res) {
                        _this.listMessage = res.projectPlans;
                        _this.getFzr();
                    }
                });
            },

            //获取所有负责人
            getFzr: function () {

                var _this = this;
                $.ajax({
                    // url: "http://106.13.24.63:8082/user/selectAllUser",
                    url:"http://106.13.24.63:8082/sys/user/selectUserByTabFlag",
                    data: {pProjectPhaseId:_this.activeName2},
                    type: "GET",
                    dataType: "json",
                    success: function (res) {
                        _this.zrr = res.data;
                    }
                });
            },

            //点击列表信息
            listClick: function (items) {
                var _this = this;
                _this.jiXianClick=1;
                _this.buttonsName = "提交";
                _this.shows = false;
                if (items.pProjectPhaseId == "需求分析") {
                    items.pProjectPhaseId = 1;
                } else if (items.pProjectPhaseId == "数据处理") {
                    items.pProjectPhaseId = 2;
                } else if (items.pProjectPhaseId == "系统开发") {
                    items.pProjectPhaseId = 3;
                };
                _this.pProjectPhaseIds = items.pProjectPhaseId;
                _this.activeName2 = String(items.pProjectPhaseId);

                _this.pid = items.pId;
                _this.pName = items.pName;
                _this.getProject(items);
            },

            /*获取项目总体甲基化清单明细*/
            getProject: function (params) {
                var _this = this;
                $.ajax({
                    url: "http://106.13.24.63:8082/projectPlan/projectPlanList",
                    data: {
                        pId: params.pId,
                        pProjectPhaseId: params.pProjectPhaseId,
                    },
                    type: "POST",
                    dataType: "json",
                    success: function (res) {
                        $(".idbody_title").html(params.pName);
                        _this.showEditOrSubmit = 1;
                        for (var i = 0; i < res.data.length; i++) {
                            var items = res.data[i];
                            if (items.aaeTime != null || items.aasTime != null || items.apeTime != null || items.apsTime != null || items.isResult != null || items.percentage != null || items.state != null || items.username != null || items.userId != null) {
                                _this.showEditOrSubmit = 2;
                                //break;
                            }
                            /*  else{
                                  _this.showEditOrSubmit=1;
                                  break;
                              };*/
                        }

                        _this.tableData = res.data;
                        console.log(_this.tableData)
                        _this.getFzr(params.pProjectPhaseId);
                    }
                });
            },
            /*点击项目总体计划明细tab*/
            handleClick: function (data) {
                var _this = this;
                _this.jiXianClick=1;
                _this.pProjectPhaseIds = Number(data.name);
                var params = {
                    pId: _this.pid,
                    pProjectPhaseId: data.name,
                    pName:_this.pName
                };
                _this.getProject(params);
            },
            /*新增项目列表事件*/
            addList: function () {
                var _this = this;
                _this.isEditOrAdd=0;
                _this.jiXianClick1=1;
                _this.isClickBtnColor1 = "#409EFF";
                _this.diaLogTitle="新增项目计划";
                _this.dialogVisible = true;


                // _this.pProjectPhaseIdDisabled=false;
                _this.forms= {
                    pId: "",
                    pName: "",//项目名称
                    pStartTime: "",//项目计划开始时间
                    pEndTime: "",//项目计划结束时间
                    pProjectPhaseId: "",//项目阶段ID
                    pProgress: "",//项目总体完成进度
                    createTime: "",//项目创建时间
                    creater: "",//项目创建人
                };

                _this.$refs.form.clearValidate();//清空之前的校验
            },
            /*提交事件*/
            //计划开始时间验证
            yzTime:function(value){
                var re = /([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8])))/;
                var isBool=false;
                if(re.test(value)){
                    isBool=true;
                };
                return isBool;
            },
            yzBfb:function(value){
                var re = /^[1-9]\d*$/;
                var isBools=false;
                if(re.test(value)){
                    isBools=true;
                };
                return isBools;
            },
            submit: function () {
                var _this = this;


                var flags=false;
                // for(var i=0;i<_this.tableData.length;i++){
                //     var items=_this.tableData[i];
                //     if(items.apsTime==""){
                //         _this.$message({
                //             message:"请输入计划开始时间",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(!_this.yzTime(items.apsTime)){
                //         _this.$message({
                //             message:"请正确的计划开始时间格式",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.apeTime==""){
                //         _this.$message({
                //             message:"请输入计划完成时间",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(!_this.yzTime(items.apeTime)){
                //         _this.$message({
                //             message:"请正确的计划完成时间格式",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.aasTime==""){
                //         _this.$message({
                //             message:"请输入实际开始时间",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(!_this.yzTime(items.aasTime)){
                //         _this.$message({
                //             message:"请正确的实际开始时间格式",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.aaeTime==""){
                //         _this.$message({
                //             message:"请输入实际完成时间",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(!_this.yzTime(items.aaeTime)){
                //         _this.$message({
                //             message:"请正确的实际完成时间格式",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.userId==null){
                //         _this.$message({
                //             message:"请选择负责人",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.percentage==null){
                //         _this.$message({
                //             message:"请输入完成百分比",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(!_this.yzBfb(items.percentage)){
                //         _this.$message({
                //             message:"请输入正确格式得百分比",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.state==null){
                //         _this.$message({
                //             message:"请选择状态",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else if(items.isResult==null){
                //         _this.$message({
                //             message:"请选择是否提交",
                //             type:"error",
                //         });
                //         flags=false;
                //         return;
                //     }else{
                //         flags=true;
                //     };
                // };
                // console.log(_this.jiXianClick)
                // if(flags==true){
                    if (_this.jiXianClick == 1) {
                        _this.jiXianClick=2;
                        _this.isClickBtnColor = "#409EFF";
                        var newArray = [];
                        for (var i = 0; i < _this.tableData.length; i++) {
                            var items = _this.tableData[i];
                            var objss = {
                                aId: items.aId,
                                aName: items.aName,
                                tsId: items.tsId,
                                aPstartTime: items.apsTime,
                                aPendTime: items.apeTime,
                                aAstartTime: items.aasTime,
                                aAendTime: items.aaeTime,
                                userId: items.userId,
                                aPercentage: items.percentage,
                                aState: items.state,
                                aIsResult: items.isResult,
                                pId: _this.pid,
                                pProjectPhaseId: _this.pProjectPhaseIds,
                            };
                            newArray.push(objss);
                        }
                        ;
                        var objs = {
                            items: newArray
                        };
                        var urls = "";
                        if (_this.showEditOrSubmit == 1) {
                            urls = "http://106.13.24.63:8082/MaintenanceProject/addProjectList";
                        } else {
                            urls = "http://106.13.24.63:8082/actionItem/updateActionItemList";
                        };
                        $.ajax({
                            url: urls,
                            data: JSON.stringify(objs),
                            type: "post",
                            dataType: "JSON",
                            contentType: "application/json;charset=utf-8",
                            success: function (res) {
                                if (res.code == 200) {
                                    _this.$message.success(res.msg);
                                    _this.pProjectPhaseIds = 1;
                                    _this.getListMessage();
                                    setTimeout(function () {
                                        _this.shows = true;
                                        _this.buttonsName = "新增项目计划";
                                    }, 2000);
                                };
                            }
                        });
                    }else{
                        _this.$message({
                            message:"请勿多次提交",
                            type:"warning",
                        });
                    }
                // };

            }
        },
        updated: function () {
            var _this = this;

        },
    });
</script>
</body>
</html>