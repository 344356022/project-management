<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge"> -->

    <title>双周计划</title>

    <!--引入element_ui的样式-->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="./element_ui/iconfont/iconfont.css">
    <link rel="stylesheet" href="./css/pages/week.css">

    <!--引入jquery-->
    <script src="./js/jquery-3.3.1.js" type="text/javascript"></script>

    <!---引入钉钉官方的script--->
    <script src="//g.alicdn.com/dingding/dingtalk-jsapi/2.6.41/dingtalk.open.js"></script>
    <script src="./element_ui/vue.js" type="text/javascript"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="./element_ui/vuex.js" type="text/javascript"></script>
    <script src="./element_ui/store.js" type="text/javascript"></script>
    <script src="./element_ui/vue-resource.js" type="text/javascript"></script>
    <script src="./element_ui/vue-router.js" type="text/javascript"></script>
    <meta name="wpk-bid" content="dta_1_269856828">

    <!--定义类样式--->
    <style>
        .tables1{
            position: relative;

        }
        .addThisWeek{
            /* position: absolute;
             top: 18px;
             left: 148px;
             z-index: 10;*/
            margin:10px 0;
        }
        .header{
            position: relative;
            width: 100%;
        }
        .header-data{
            position: absolute;
            left: 10px;
            bottom: 4px;
            font-size: 12px;
        }
        .header-title{
            width: 100%;
            text-align: center;
            line-height: 60px;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<!--给div标签定义一个id选择器-->
<div id="idbody">

    <div class="header">
        <div class="header-title">项目双周计划</div>
        <div class="header-data">计划期间：<span class="startTime"></span>--<span class="endTime"></span></div>
    </div>
    <div class="tables1">
        <div style="display:flex;justify-content:flex-end;">
            <el-button type="primary" @click="save" class="addThisWeek" size="small">保存</el-button>
            <el-button type="primary" size="small" class="addThisWeek" @click="addThisWeek">新增</el-button>

        </div>

        <el-table class="tables"
                  border
                  :data="tableData">
            <el-table-column
                    align="center"
                    label="本周完成情况"
                    min-width="60"
            >
                <template slot-scope="scope">
                    <ul>
                        <li v-for="(items,index) in scope.row.recordTimes"  v-text="items.name.substr(3,2)" :class="{clickIndex:items.isSelect=='true'}" @click="dataClick(scope.$index, scope.row,items,index)"></li>
                    </ul>
                </template>
            </el-table-column>



            <el-table-column
                    align="center"
                    label="项目名称"
                    prop="pId"
                    min-width="70"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.pId" @change="xmmcChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in xmName"
                                :key="item.pId"
                                :label="item.pName"
                                :value="item.pId">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="任务项"
                    prop="tsId"
                    min-width="70"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.tsId" @change="rwxChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in rwx"
                                :key="item.tsId"
                                :label="item.tsName"
                                :value="item.tsId">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="工作任务描述"
                    prop="wWorkReport"
            >
                <template slot-scope="scope">
                    <el-input
                            @change="rwmsChange"
                            type="textarea"
                            autosize
                            placeholder="请输入工作任务描述"
                            v-model="scope.row.wWorkReport">
                    </el-input>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="责任人"
                    prop="userId"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.userId" @change="fzrChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in zrr"
                                :key="item.userId"
                                :label="item.uName"
                                :value="item.userId">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="实际完成率"
                    prop="wActualProportion"
                    min-width="30"
            >
                <template slot-scope="scope">
                    <el-input v-model="scope.row.wActualProportion" :disabled="true" placeholder="实际完成百分比"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="计划完成率"
                    prop="wPlanProportion"
                    min-width="30"
            >
                <template slot-scope="scope">
                    <el-input v-model="scope.row.wPlanProportion" @change="jhbfbChange" placeholder="计划完成百分比"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="状态"
                    prop="wStatus"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.wStatus" @change="statusChange" :disabled="scope.row.statusDisabled" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in wStatusList"
                                :key="item.value"
                                :label="item.name"
                                :value="item.value">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="备注\协调配合"
                    prop="wRemark"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-input type="textarea" @change="bzChange"
                              autosize v-model="scope.row.wRemark" placeholder="备注\协调配合"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="操作"
                    prop="wRemark"
                    min-width="20"
            >
                <template slot-scope="scope">
                    <img src="./imgs/shanchu.png" @click="delThisWeek(scope.row,scope)" style="width: 15px;cursor:pointer;"/>
                </template>
            </el-table-column>
        </el-table>

    </div>

    <div class="tables1">
        <div style="display:flex;justify-content:flex-end;">
            <el-button type="primary" size="small" class="addThisWeek" @click="addNextWeek">新增</el-button>
        </div>

        <el-table class="tables"
                  border
                  :data="tableData1">
            <el-table-column
                    align="center"
                    label="下周完成情况"
                    min-width="60"
            >
                <template slot-scope="scope">
                    <ul>
                        <li v-for="(items,index) in scope.row.recordTimes"  v-text="items.name.substr(3,2)" :class="{clickIndex:items.isSelect=='true'}" @click="dataClick(scope.$index, scope.row,items,index)"></li>
                    </ul>
                </template>
            </el-table-column>



            <el-table-column
                    align="center"
                    label="项目名称"
                    prop="pId"
                    min-width="70"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.pId" @change="xmmcChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in xmName"
                                :key="item.pId"
                                :label="item.pName"
                                :value="item.pId">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="任务项"
                    prop="tsId"
                    min-width="70"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.tsId" @change="rwxChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in rwx"
                                :key="item.tsId"
                                :label="item.tsName"
                                :value="item.tsId">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="工作任务描述"
                    prop="wWorkReport" >
                <template slot-scope="scope">
                    <el-input
                            @change="rwmsChange"
                            type="textarea"
                            autosize
                            placeholder="请输入工作任务描述"
                            v-model="scope.row.wWorkReport">
                    </el-input>
                </template>
            </el-table-column>

            <el-table-column
                    align="center"
                    label="责任人"
                    prop="userId"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.userId"  @change="fzrChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in zrr"
                                :key="item.userId"
                                :label="item.uName"
                                :value="item.userId">
                        </el-option>
                    </el-select>

                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="实际完成率"
                    prop="wActualProportion"
                    min-width="30"
            >
                <template slot-scope="scope">
                    <el-input v-model="scope.row.wActualProportion" :disabled="true" placeholder="实际完成百分比"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="计划完成率"
                    prop="wPlanProportion"
                    min-width="30"
            >
                <template slot-scope="scope">
                    <el-input v-model="scope.row.wPlanProportion" @change="jhbfbChange" placeholder="计划完成百分比"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="状态"
                    prop="wStatus"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-select v-model="scope.row.wStatus" :disabled="scope.row.statusDisabled" @change="statusChange" placeholder="请选择">
                        <el-option
                                v-for="(item,index) in wStatusList"
                                :key="item.value"
                                :label="item.name"
                                :value="item.value">
                        </el-option>
                    </el-select>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="备注\协调配合"
                    prop="wRemark"
                    min-width="40"
            >
                <template slot-scope="scope">
                    <el-input type="textarea"
                              @change="bzChange"
                              autosize v-model="scope.row.wRemark" placeholder="备注\协调配合"></el-input>
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="操作"
                    min-width="20"
            >
                <template slot-scope="scope">
                    <img src="./imgs/shanchu.png" @click="delNextWeek(scope.row,scope)" style="width: 15px;cursor:pointer;"/>
                </template>
            </el-table-column>
        </el-table>
    </div>


</div>
</body>

<script>
    var dataLists=[];
    var thisWeek=[];//本周数据
    var nextWeek=[];//下周数据
    (function () {
        $.ajax({
            url:"http://106.13.19.215:8082/weekReport/getTwelveDayDate",
            type:"GET",
            data:{},
            dataType:"json",
            success:function(res){
                dataLists=res.data;
                $(".startTime").text(dataLists[0]);
                $(".endTime").text(dataLists[11]);
                thisWeek=dataLists.slice(0,7);
                nextWeek=dataLists.slice(-5);
            }
        });




    })(window)



    var myHome = new Vue({
        el:"#idbody",
        data:{
            code:"",
            //任务项
            rwx:[],
            //项目名称
            xmName:[],
            //责任人
            zrr:[],
            tableData:[],//本周完成情况
            tableData1:[],//下周完成情况

            //状态值

            wStatusList:[
                {
                    name:"进行中",
                    value:1,
                },
                {
                    name:"暂停",
                    value:2,
                },
                {
                    name:"已完成",
                    value:3,
                }
            ],

            flags:true,

            dubClick:1,//禁止双击保存
        },
        mounted:function(){
            var _this=this;
            _this.getDingDing();//获取临时授权码
           //_this.getDatas();
        },
        created:function () {
            var _this=this;

        },
        methods:{
            //项目名称改变事件
            xmmcChange:function(){
                var _this=this;
                _this.dubClick=1;
            },

            //任务项名称改变事件
            rwxChange:function () {
                var _this=this;
                _this.dubClick=1;
            },
            //任务描述
            rwmsChange:function(){
                var _this=this;
                _this.dubClick=1;
            },

            //责任人名称改变事件
            fzrChange:function () {
                var _this=this;
                _this.dubClick=1;
            },
            //计划完成率
            jhbfbChange:function(){
                var _this=this;
                _this.dubClick=1;
            },
            //状态名称改变事件
            statusChange:function () {
                var _this=this;
                _this.dubClick=1;
                
            },
            //备注、协调配合
            bzChange:function(){
                var _this=this;
                _this.dubClick=1;
            },

            //获取有关钉钉需要的值
            getDingDing:function () {
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/weekReport/queryEmterpriseMesg",
                    type:"GET",
                    data:{},
                    dataType:"json",
                    success:function(res){
                        _this.getCode(res);
                    }
                });
            },

            //获取临时授权码,
            getCode:function (_config) {
                console.log(_config);
                var _this=this;
                dd.ready(function() {
                    dd.runtime.permission.requestAuthCode({
                        corpId:_config.corpId, // 企业id
                        onSuccess: function (info) {
                            _this.code=info.code;
                            _this.getDatas(info.code);//回显保存的数据
                        },
                        onFail : function(err) {
                            alert('fail: ' + JSON.stringify(err));
                        }
                    });
                });

            },

            /*获取已经保存过后的数据*/
            getDatas:function (code) {
                var _this=this;
                /* var objs={
                     authCode:code,
                 }*/
                _this.tableData=[];
                _this.tableData1=[];

                $.ajax({
                    url:"http://106.13.19.215:8082/weekReport/selectWeekReportDetial",
                    type:"POST",
                    data:{'authCode':code},
                    //data:{},
                    dataType:"json",
                    success:function(res){
                        if(res.data!=null){
                            for(var i=0;i<res.data.length;i++){
                                var items=res.data[i];
                                if(items.wStatus==3){
                                    items.statusDisabled=true;
                                }else{
                                    items.statusDisabled=false;
                                };
                                if(items.wType==1){
                                    _this.tableData.push(items);
                                }else{
                                    _this.tableData1.push(items);
                                };
                            };
                        }
                        _this.getRwx();
                        /* _this.rwx=res.data;
                         _this.getXmmc();*/
                    }
                });
            },
            //获取任务项
            getRwx:function(data){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/weekReport/queryTaskSubIdAndName",
                    type:"GET",
                    data:{},
                    dataType:"json",
                    success:function(res){
                        _this.rwx=res.data;
                        _this.getXmmc();
                    }
                });
            },
            //获取项目名称
            getXmmc:function(){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/weekReport/selectProjectPlanIdAndName",
                    type:"GET",
                    data:{},
                    dataType:"json",
                    success:function(res){
                        _this.xmName=res.data;
                        _this.getZrr();
                    }
                });
            },
            /*获取责任人*/
            getZrr:function(){
                var _this=this;
                $.ajax({
                    url:"http://106.13.19.215:8082/weekReport/selectUserByDepartment",
                    type:"GET",
                    data:{},
                    dataType:"json",
                    success:function(res){
                        _this.zrr=res.data;
                    }
                });
            },
            //新增本周
            addThisWeek:function(){
                var _this=this;
                _this.dubClick=1;
                //本周日期
                var thisWeeks=[];
                for(var i=0;i<thisWeek.length;i++){
                    var items=thisWeek[i];

                    var objs={
                        isSelect:'false',
                        nums:0,
                        name:thisWeek[i].substr(5,5),
                        timeId:"",
                        wId:"",
                        sorts:i+1,
                    };
                    thisWeeks.push(objs);
                };
                var objs={
                    recordTimes:thisWeeks,
                    pId:"",
                    tsId:"",
                    userId:"",
                    wActualProportion:"",
                    wPlanProportion:"",
                    wWorkReport:"",
                    wStatus:"",
                    wRemark:"",
                    wType:"1",
                };

                _this.tableData.push(objs);

            },
            //新增下周
            addNextWeek:function () {
                var _this=this;
                _this.dubClick=1;
                //本周日期
                var nextWeeks=[];
                for(var i=0;i<nextWeek.length;i++){
                    var items=nextWeek[i];

                    var objs={
                        isSelect:'false',
                        nums:0,
                        name:nextWeek[i].substr(5,5),
                        timeId:"",
                        wId:"",
                        sorts:i+1,
                    };
                    nextWeeks.push(objs);
                };
                var objs={
                    recordTimes:nextWeeks,
                    pId:"",
                    tsId:"",
                    userId:"",
                    wActualProportion:"",
                    wPlanProportion:"",
                    wStatus:"",
                    wWorkReport:"",
                    wRemark:"",
                    wType:"2",
                };

                _this.tableData1.push(objs);
            },
            //删除本周
            delThisWeek:function (params,scope) {
                var _this=this;
                _this.dubClick=1;
                console.log(params,scope);
                if(!params.wId){
                    _this.tableData.splice(scope.$index,1);
                }else{
                    _this.tableData.splice(scope.$index,1);
                    var objs={
                        wId:params.wId,
                    };
                    $.ajax({
                        url:"http://106.13.19.215:8082/weekReport/deleteWeekReportById",
                        data:objs,
                        type:"POST",
                        dataType:"json",
                        success:function(res){
                            _this.$message({
                                message:"删除成功",
                                type:"success",
                            });
                            // _this.getCode();
                        }
                    });
                };
            },
            //删除下周
            delNextWeek:function (params,scope) {
                var _this=this;
                _this.dubClick=1;
                if(!params.wId){
                    _this.tableData1.splice(scope.$index,1);
                }else{
                    _this.tableData1.splice(scope.$index,1);
                    var objs={
                        wId:params.wId,
                    };
                    $.ajax({
                        url:"http://106.13.19.215:8082/weekReport/deleteWeekReportById",
                        data:objs,
                        type:"POST",
                        dataType:"json",
                        success:function(res){
                            console.log(res);
                            _this.$message({
                                message:"删除成功",
                                type:"success",
                            });
                            // _this.getCode();
                        }
                    });
                };
            },
            //点击日期
            dataClick:function(scopeIndex,scopeRow,items,itemsIndex){
                var _this=this;
                _this.dubClick=1;
                var itemss=scopeRow.recordTimes[itemsIndex];
                itemss.nums++;
                if(itemss.nums%2==0){
                    itemss.isSelect='false';
                    itemss.nums=0;
                }else{
                    itemss.isSelect='true';
                };
            },
            //检验是饭否时间选择
            yanZhengTime:function (data) {
                var newArray=[];
                for(var i=0;i<data.length;i++){
                    var items=data[i];
                    if(items.isSelect=="true"){
                        newArray.push(items);
                    };
                };
                return newArray;
            },

            //保存
            save:function(){
                var _this=this;
                var flags=false;

                var newArray=[];
                newArray=_this.tableData.concat(_this.tableData1);
                var objs={
                    thisWeek:_this.tableData,
                };
                for(var i=0;i<newArray.length;i++){
                    var items=newArray[i];
                    console.log(items)
                    if(_this.yanZhengTime(items.recordTimes).length<=0){
                        _this.$message({
                            message:"请选择计划完成得时间",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else if(items.pId==""){
                        _this.$message({
                            message:"请选择项目名称",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else if(items.tsId==""){
                        _this.$message({
                            message:"请选择任务项",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else if(items.wWorkReport==""){
                        _this.$message({
                            message:"请输入工作描述",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else if(items.userId==""){
                        _this.$message({
                            message:"请选择责任人",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else if(items.wPlanProportion==""){
                        _this.$message({
                            message:"请输入计划完成率",
                            type:"error",
                        })
                        flags=false;
                        return;
                    }else if(items.wStatus==""){
                        _this.$message({
                            message:"请选择状态",
                            type:"error",
                        });
                        flags=false;
                        return;
                    }else{
                        flags=true;
                    };
                };
                console.log(flags);
                if(flags==true){
                    console.log(_this.dubClick)
                    if(_this.dubClick==1){
                        _this.dubClick=2;
                        var objs={
                            weekreports:newArray,
                        };

                        $.ajax({
                            url:"http://106.13.19.215:8082/weekReport/createMoreWeekReport",
                            data:JSON.stringify(objs),
                            type:"POST",
                            dataType:"json",
                            contentType: "application/json;charset=utf-8",
                            success:function(res){
                                _this.$message({
                                    message:"保存成功",
                                    type:"success",
                                });
                                _this.flags=true;
                                _this.getDingDing();
                            }
                        });
                    }else{
                        _this.$message({
                            message:"请勿多次保存",
                            type:"warning",
                        });
                    };

                };


            },

        },
        updated:function(){
            var _this=this;
        },
    });
</script>
</html>