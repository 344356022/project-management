<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gedi.projectmanagement.dao.ProjectPlanMapper">
    <resultMap id="BaseResultMap" type="com.gedi.projectmanagement.model.ProjectPlan">
        <id column="p_id" property="pId" jdbcType="VARCHAR"/>
        <result column="p_name" property="pName" jdbcType="VARCHAR"/>
        <result column="p_start_time" property="pStartTime" jdbcType="DATE"/>
        <result column="p_end_time" property="pEndTime" jdbcType="DATE"/>
        <result column="p_project_phase_id" property="pProjectPhaseId" jdbcType="INTEGER"/>
        <result column="p_progress" property="pProgress" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="DATE"/>
        <result column="creater" property="creater" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
    p_id, p_name, p_start_time, p_end_time, p_project_phase_id, p_progress, create_time,
    creater
    </sql>


    <!-- 根据ID查询用于项目总体计划列表展示 -->
    <select id="selectById" resultMap="BaseResultMap" parameterType="java.lang.String">
    select
    p_id,
    p_name,
    p_start_time,
    p_end_time,
    p_project_phase_id,
    p_progress,
    create_time,
    creater
    from project_plan
    where p_id = #{pId}
  </select>

    <!-- 新增项目总计划 -->
    <insert id="addProject" parameterType="com.gedi.projectmanagement.model.ProjectPlan">
        insert into project_plan
        ( p_id, p_name,
          p_start_time,
          p_end_time,
          p_project_phase_id,
          p_progress,
          create_time,
          creater)
        values
        <foreach collection="list" item="item" open="" close="" separator=";">
        ( #{item.pId,jdbcType=VARCHAR},
          #{item.pName,jdbcType=VARCHAR},
          #{item.pStartTime,jdbcType=DATE},
          #{item.pEndTime,jdbcType=DATE},
          #{item.pProjectPhaseId,jdbcType=INTEGER},
          #{item.pProgress,jdbcType=INTEGER},
          #{item.createTime,jdbcType=DATE},
          #{item.creater,jdbcType=VARCHAR})
        </foreach>
      </insert>


    <!-- 根据pName模糊查询项目总体计划列表展示 -->
    <select id="selectBypName" resultMap="BaseResultMap" parameterType="java.lang.String">
    select
    p_id,
    p_name,
    p_start_time,
    p_end_time,
    p_project_phase_id,
    p_progress,
    create_time,
    creater
    from project_plan
    where p_name LIKE '%' #{pName} '%'
  </select>

    <!-- 根据pId和pProjectPhase查询用于项目总体计划清单列表展示 -->
    <select id="selectProjectPlanListByPidAndpProjectPhaseId" resultType="ProjectPlanList">
       SELECT
	p.p_project_phase_id AS pProjectPhaseId,
	t.t_name AS tName,
	tts. NAME AS tsName,
	tsai.aname AS aName,
	tsai.apstime AS apsTime,
	tsai.apetime AS apeTime,
	tsai.aastime AS aasTime,
	tsai.aaetime AS aaeTime,
	tsai.percentage AS percentage,
	tsai.state AS state,
	tsai.isresult AS isResult,
	username,
	t.sort_id AS sortId
FROM
	(
		project_plan AS p
		LEFT JOIN task_class AS t ON p.p_id = t.p_id
	)
LEFT JOIN (
	SELECT
		t.t_id AS id,
		ts.ts_name AS NAME,
		ts.ts_id AS tsid
	FROM
		task_class AS t
	LEFT JOIN task_subclass AS ts ON t.t_id = ts.t_id
) AS tts ON t.t_id = tts.id
LEFT JOIN (
	SELECT
		ts.ts_id AS id,
		ai.`a_ name` AS aname,
		ai.a_pstart_time AS apstime,
		ai.a_pend_time AS apetime,
		ai.a_astart_time AS aastime,
		ai.a_aend_time AS aaetime,
		ai.a_percentage AS percentage,
		ai.a_state AS state,
		ai.a_is_result AS isresult,
		ai.a_id AS aid
	FROM
		task_subclass AS ts
	LEFT JOIN action_item AS ai ON ts.ts_id = ai.ts_id
) AS tsai ON tts.tsid = tsai.id
LEFT JOIN (
	SELECT
		ai.a_id AS id,
		pum.user_id AS userId
	FROM
		action_item AS ai
	LEFT JOIN project_user_medium pum ON ai.a_id = pum.a_id
) AS aip ON tsai.aid = aip.id
LEFT JOIN (
	SELECT
		u.u_name AS username,
		pum.user_id AS id,
		pum.a_id AS aId
	FROM
		project_user_medium pum
	LEFT JOIN `user` u ON pum.user_id = u.user_id
) AS puser ON aip.id = puser.aId
WHERE
	p.p_id = #{pId} AND t.p_project_phase_id = #{pProjectPhaseId}
	ORDER BY sortId ASC
    </select>

    <!--查询所有得项目名称以及ID值-->
    <select id="selectAllProject" resultMap="BaseResultMap">
        SELECT p_name,p_id from project_plan
    </select>

</mapper>